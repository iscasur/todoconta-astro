---

const url = `https://sendy.todoconta.com/api/subscribers/active-subscriber-count.php`
const response = await fetch(url, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
        api_key: '5a7Ijeup4Dmx0S3QghQ3',
        list_id: 'k10AD2h1Bu4fTfy763prrdpA',
    }),
})
const activeSubscriberCount = response.text()
---
<div class="prose dark:prose-invert border border-solid border-b-black p-4 rounded-lg">
  <h3>SuscrÃ­bete nuestro newsletter</h3>
  <p>Ãšnete a nuestros {activeSubscriberCount} que ya lo han hecho</p>
  <form id="subscribeForm">
    <label for="name" class="block">
      <span class="text-gray-700">Nombre</span>
      <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" />
    </label>
    <label for="email">
      <span class="text-gray-700">Email</span>
      <input type="email" id="email" name="email" placeholder="Correo electrÃ³nico" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" />
    </label>
    <input type="submit" value="Â¡Me uno!" class="w-full" />
    <p id="message"></p>
  </form>
</div>

<script>
    const form = document.getElementById('subscribeForm') as HTMLFormElement;
    const messageContainer = document.getElementById('message');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = {
            api_key: '5a7Ijeup4Dmx0S3QghQ3',
            list: 'k10AD2h1Bu4fTfy763prrdpA',
            name: formData.get('name').toString() || '',
            email: formData.get('email').toString() || '',
            boolean: 'true',
        }

        try {
            const response = await fetch('https://sendy.todoconta.com/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data),
            });

            if (response.ok) {
                const responseText = await response.text();

                if (responseText === '1') {
                  messageContainer.textContent = 'Te has suscrito con Ã©xito ðŸŽ‰';
                  if (form instanceof HTMLFormElement) {
                    form.reset()
                  } else {
                    console.error('The provided element is not a valid form.');
                  }
                } else if (responseText === 'Already subscribed.') {
                  messageContainer.textContent = 'Parece que ya te habÃ­as suscrito antes ðŸ¤”';
                } else {
                  messageContainer.textContent = `Error: ${responseText}`;
                }
            }


        } catch (e) {
            console.error('Error subscribing user:', e);
            alert('OcurriÃ³ un error al suscribirte, intenta mas tarde');
        }
    })
</script>